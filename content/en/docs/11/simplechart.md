---
title: "11.3 Create a Chart"
weight: 113
sectionnumber: 11.3
---

In this lab, we're going to create our very first Helm chart and deploy it.


## Task {{% param sectionnumber %}}.1: Create Chart

First let's create our chart:

```bash
helm create mychart
```

You'll now find a `mychart` directory with the newly created chart. It already is a valid and fully functional chart which deploys nginx. Have a look at the generated files and their content. For an explanation of the files, visit the [Helm Developer Documentation](https://docs.helm.sh/developing_charts/#the-chart-file-structure). In a later section you'll find all the information about Helm templates.


## Task {{% param sectionnumber %}}.2: Install Release

Before actually deploying our generated chart, we can check the (to be) generated Kubernetes resources with the following command:


```bash
helm install --dry-run --debug --namespace <namespace> myfirstrelease ./mychart
```

{{% onlyWhen openshift %}}
The default image freshly created chart deploys is a simple nginx image listening on port `80`.

Since OpenShift doesn't allow to run containers as root by default, we need to change the default image to an unprivileged one (`nginxinc/nginx-unprivileged:latest`) and also change the containerPort to `8080`.

Change the image in the `mychart/values.yaml`

```yaml
...
image:
  repository: nginxinc/nginx-unprivileged
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: "latest"
...
```

And then change the containerPort in the `mychart/templates/deployment.yaml`

```yaml
...
ports:
- name: http
  containerPort: 8080
  protocol: TCP
...
```


{{% /onlyWhen %}}


Finally, the following command creates a new release and deploys the application:

```bash
helm install --namespace <namespace> myfirstrelease ./mychart
```

The `name` parameter allows you to give your release a name, it is not mandatory though, the name will be autogenerated if no explicit name is provided.

With `{{% param cliToolName %}} get pods --namespace <namespace>` you should see a new Pod. You can list the newly created Helm release with the following command:

```bash
helm ls --namespace <namespace>
```


## Task {{% param sectionnumber %}}.3: Expose Application

Our freshly deployed nginx is not yet accessible from outside the {{% param distroName %}} cluster.
{{% onlyWhen openshift %}}
To expose it, we have to make sure a so called ingress resource will be deployed as well.
Have a look at the file `templates/ingress.yaml` and the ingress section of the `mychart/values.yaml`


### Solution Task 3

A look into the file `templates/ingress.yaml` reveals that the rendering of the ingress and its values is configurable through values:

```yaml
{{- if .Values.ingress.enabled -}}
{{- $fullName := include "mychart.fullname" . -}}
{{- $svcPort := .Values.service.port -}}
{{- if semverCompare ">=1.14-0" .Capabilities.KubeVersion.GitVersion -}}
apiVersion: networking.k8s.io/v1beta1
{{- else -}}
apiVersion: extensions/v1beta1
{{- end }}
kind: Ingress
metadata:
  name: {{ $fullName }}
  labels:
    {{- include "mychart.labels" . | nindent 4 }}
  {{- with .Values.ingress.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- if .Values.ingress.tls }}
  tls:
    {{- range .Values.ingress.tls }}
    - hosts:
        {{- range .hosts }}
        - {{ . | quote }}
        {{- end }}
      secretName: {{ .secretName }}
    {{- end }}
  {{- end }}
  rules:
    {{- range .Values.ingress.hosts }}
    - host: {{ .host | quote }}
      http:
        paths:
          {{- range .paths }}
          - path: {{ .path }}
            backend:
              serviceName: {{ $fullName }}
              servicePort: {{ $svcPort }}
          {{- end }}
    {{- end }}
  {{- end }}
```

Thus, we need to change this value inside our `mychart/values.yaml` file:

{{% alert title="Note" color="primary" %}}
Make sure to replace the `<namespace>` and `<appdomain>` accordingly.
{{% /alert %}}

```yaml
...
ingress:
  enabled: true
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts:
    - host: mychart-<namespace>.<appdomain>
      paths:
      - path: /
  tls: []
  #  - secretName: chart-example-tls
  #    hosts:
  #      - chart-example.local
...
```

Apply the change by upgrading our release:


```bash
helm upgrade --namespace <namespace> myfirstrelease ./mychart
```

Verify the successful deployment in your browser `http://mychart-<namespace>.<appdomain>`.
{{% /onlyWhen %}}

{{% onlyWhenNot openshift %}}
To expose it, we have to change the Service type to `NodePort`.
Search for the Service type definition in your chart and make the change.


### Solution Task 3

A look into the file `templates/service.yaml` reveals that the Service type is set by value:

```yaml
...
spec:
  type: {{ .Values.service.type }}
...
```

Thus, we need to change this value inside our `mychart/values.yaml` file:

```yaml
...
service:
  type: NodePort
  port: 80
...
```

Apply the change by upgrading our release:


```bash
helm upgrade --namespace <namespace> myfirstrelease ./mychart
```

You will see in the following command's output when the Service gets a `NodePort` (as we use `--watch` you have to terminate the command with CTRL-C):

```bash
{{% param cliToolName %}} get svc --namespace <namespace> --watch
```

nginx is now available at the given port number indicated by the `NodePort` and should display a welcome page when accessing it with `curl` or your browser of choice.


{{% alert title="Note" color="primary" %}}
Use `{{% param cliToolName %}} get node -o wide` to get a node ip address. Remember, [NodePort's](https://kubernetes.io/docs/concepts/services-networking/service/#nodeport) are open on any kubernetes node
{{% /alert %}}

{{% /onlyWhenNot %}}


## Task {{% param sectionnumber %}}.4: Overwrite value using commandline param

An alternative way to set or overwrite values for charts we want to deploy is the `--set name=value` parameter. `--set name=value` can be used when installing a chart as well as upgrading.

Update the replica count of your nginx Deployment to 2 using `--set name=value`


### Solution Task 4

```bash
helm upgrade --namespace <namespace> --set replicaCount=2 myfirstrelease ./mychart
```

Values that have been set using `--set` can be reset by helm upgrade with `--reset-values`.


## Task {{% param sectionnumber %}}.5: Remove release

To remove an application, simply remove the Helm release with the following command:

```bash
helm delete myfirstrelease
```

Do this with our deployed release. With `{{% param cliToolName %}} get pods --namespace <namespace>` you should no longer see your application Pod.
